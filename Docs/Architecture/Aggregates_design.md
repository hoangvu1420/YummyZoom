# Proposed Aggregates and Their Detailed Structures

**1. `User` Aggregate**

- **Aggregate Root:** `User`
- **Description:** Represents an individual interacting with the platform, whether a customer, restaurant staff, or admin. Manages user identity, preferences, and associated personal data including their specific roles and linked entities.
- **Entities/Value Objects (VOs) within:**
  - `User` (Entity - Root):
    - `UserID` (Identifier)
    - `Name`
    - `Email` (Unique identifier for login)
    - `PasswordHash` (*Essential for authentication - adding this as it's a core part of a User entity*)
    - `PhoneNumber` (Optional)
    - **`RoleAssignments` (List of `RoleAssignment` VOs):**
      - Each `RoleAssignment` VO contains:
        - `RoleName` (String, e.g., "Customer", "Admin", "RestaurantOwner", "RestaurantStaff")
        - `TargetEntityID` (Optional Identifier, e.g., `RestaurantID`. This would be `null` for global roles like "Admin" or "Customer".)
        - `TargetEntityType` (Optional String, e.g., "Restaurant". This would be `null` for global roles.)
  - `Address` (List of VOs):
    - `Street`
    - `City`
    - `State`
    - `ZipCode`
    - `Country`
    - `Label` (e.g., "Home", "Work")
    - `DeliveryInstructions` (Optional)
  - `PaymentMethod` (List of Child Entities):
    - `PaymentMethodID` (Identifier)
    - `Type` (e.g., "Card", "PayPal")
    - `TokenizedDetails` (e.g., Stripe token, last 4 digits, expiry)
    - `IsDefault` (Boolean)
- **Invariants:**
  - `Email` uniqueness: While the aggregate might not strictly enforce global uniqueness (this is often a database constraint checked by an application service during user creation/update), the domain expects it.
  - A user must have at least one `RoleAssignment` (e.g., a "Customer" role by default).
  - For a `RoleAssignment`, if `TargetEntityID` is present, `TargetEntityType` must also be present and specify a valid entity type in the system (e.g., "Restaurant").
  - `PaymentMethod` (if added) must be valid.
- **References to other aggregates (by ID):**
  - `RoleAssignment.TargetEntityID` can reference `RestaurantID`.

**2. `Restaurant` Aggregate**

- **Aggregate Root:** `Restaurant`
- **Description:** Manages all information and operational aspects of a single restaurant, including its profile, offerings (menu, items, customizations), and staff associations.
- **Entities/Value Objects (VOs) within:**
  - `Restaurant` (Entity - Root):
    - `RestaurantID` (Identifier)
    - `Name`
    - `LogoURL`
    - `ContactInfo` (VO: `PhoneNumber`, `Email`)
    - `BusinessHours` (VO or structured data, e.g., list of daily hours)
    - `Location` (`Address` VO - physical location of the restaurant)
    - `CuisineType` (String or list of strings)
    - `Description`
    - `IsVerified` (Boolean - for admin approval)
    - `IsAcceptingOrders` (Boolean)
  - `ReusableCustomizationGroup` (List of Entities):
    - `GroupID` (Identifier)
    - `GroupName` (e.g., "Milk Options", "Spice Level", "Standard Toppings")
    - `MinSelections` (Integer, e.g., 0 for optional, 1 for required)
    - `MaxSelections` (Integer, e.g., 1 for single choice, N for multiple)
    - `Choices` (List of `CustomizationChoice` VOs):
      - `ChoiceID` (Identifier, unique within the group)
      - `ChoiceName` (e.g., "Skim Milk", "Medium", "Extra Cheese")
      - `PriceAdjustment` (Money VO)
      - `IsDefault` (Boolean, optional)
  - `Menu` (List of Entities):
    - `MenuID` (Identifier)
    - `MenuName` (e.g., "Lunch", "All Day")
    - `IsEnabled` (Boolean)
    - `MenuItems` (List of `MenuItem` Entities):
      - `MenuItemID` (Identifier)
      - `ItemName`
      - `ItemDescription`
      - `BasePrice` (Money VO)
      - `ImageURL` (Optional)
      - `IsAvailable` (Boolean - "out of stock" toggle)
      - `DietaryTagIDs` (List of `TagID`s - references `Tag` aggregate)
      - `AppliedCustomizations` (List of `MenuItemCustomizationSetting` VOs):
        - `SettingTitle` (e.g., "Choose your milk", "Add toppings", "Select Spice Level") - *This is the title presented to the customer for this group of choices on this item.*
        - Reference to a `ReusableCustomizationGroupID` OR
        - `AdHocCustomizationGroup` (VO, structure similar to `ReusableCustomizationGroup` but defined inline for this item only, for unique one-off customizations). This would include its own `MinSelections`, `MaxSelections`, and `Choices`.
- **Invariants:**
  - A `MenuItem` must belong to a `Menu`.
  - A `Menu` must belong to this `Restaurant`.
  - `MenuItem.BasePrice` must not be negative.
  - `ReusableCustomizationGroup.GroupName` should be unique within the restaurant.
  - An `AppliedCustomization` on a `MenuItem` must correctly reference an existing `ReusableCustomizationGroupID` if not ad-hoc.
- **References to other aggregates (by ID):**
  - `MenuItem.DietaryTagIDs` (List of `TagID`s).
  - (Implied) Staff `UserID`s are managed via roles/permissions, linking `User`s to this `Restaurant`.

**3. `Order` Aggregate**

- **Aggregate Root:** `Order`
- **Description:** Represents a customer's request for items from a restaurant. Manages the entire lifecycle of an order from placement to (simulated) delivery, including items, payment, and status.
- **Entities/Value Objects (VOs) within:**
  - `Order` (Entity - Root):
    - `OrderID` (Identifier)
    - `OrderNumber` (Human-readable sequence)
    - `Status` (Enum: Placed, Accepted, Preparing, ReadyForDelivery, Delivered, Cancelled, Rejected)
    - `PlacementTimestamp`
    - `LastUpdateTimestamp`
    - `EstimatedDeliveryTime` (Timestamp or Duration - mock logic)
    - `SpecialInstructions` (From customer)
    - `Subtotal` (Money VO - sum of items before discounts/taxes)
    - `DiscountAmount` (Money VO)
    - `TaxAmount` (Money VO - if applicable)
    - `TotalAmount` (Money VO)
    - `DeliveryAddress` (`Address` VO - snapshot of customer's chosen address at time of order)
  - `OrderItem` (List of Entities):
    - `OrderItemID` (Identifier)
    - `Snapshot_MenuItemID` (ID of the original `MenuItem`)
    - `Snapshot_ItemName`
    - `Snapshot_BasePriceAtOrder` (Money VO)
    - `Quantity`
    - `SelectedCustomizations` (List of `OrderItemCustomization` VOs):
      - `Snapshot_CustomizationGroupName` (e.g., "Milk Options", "Pizza Toppings")
      - `Snapshot_ChoiceName` (e.g., "Almond Milk", "Pepperoni")
      - `Snapshot_ChoicePriceAdjustmentAtOrder` (Money VO)
    - `LineItemTotal` (Money VO - `(BasePrice + sum of CustomizationAdjustments) * Quantity`)
  - `PaymentTransaction` (List of Child Entities - if tracking multiple attempts/refunds):
    - `TransactionID` (Identifier)
    - `Type` (Enum: Payment, Refund)
    - `Amount` (Money VO)
    - `Status` (Enum: Pending, Succeeded, Failed)
    - `Timestamp`
    - `PaymentGatewayReferenceID` (Optional)
- **Invariants:**
  - `TotalAmount` must equal `Subtotal` - `DiscountAmount` + `TaxAmount`.
  - `Subtotal` must equal the sum of all `OrderItem.LineItemTotal`s.
  - Order status transitions must follow a valid sequence (e.g., cannot go from Placed to Delivered directly).
  - An order cannot be marked as paid if the sum of successful `PaymentTransaction`s (payments minus refunds) does not cover the `TotalAmount`.
- **References to other aggregates (by ID):**
  - `CustomerID` (`UserID` of the customer who placed the order).
  - `RestaurantID` (The restaurant fulfilling the order).
  - `AppliedCouponID` (`CouponID` used on this order).

**4. `Coupon` Aggregate**

- **Aggregate Root:** `Coupon`
- **Description:** Manages promotional coupons, including their rules, validity, and usage tracking.
- **Entities/Value Objects (VOs) within:**
  - `Coupon` (Entity - Root):
    - `CouponID` (Identifier)
    - `Code` (String - what the customer enters, unique per restaurant or globally)
    - `Description`
    - `Type` (Enum: Percentage, FixedAmount, FreeItem)
    - `Value` (Decimal for percentage, Money VO for fixed amount, `MenuItemID` for free item)
    - `AppliesTo` (VO: `Scope` [Enum: WholeOrder, SpecificItems, SpecificCategories], `ItemIDs` [List of `MenuItemID`s if scope is SpecificItems], `CategoryNames` [List of strings if scope is SpecificCategories])
    - `MinOrderAmount` (Money VO, optional condition for applicability)
    - `ValidityStartDate`
    - `ValidityEndDate`
    - `UsageLimitPerUser` (Integer, optional)
    - `TotalUsageLimit` (Integer, optional)
    - `CurrentTotalUsageCount` (Integer)
    - `IsEnabled` (Boolean)
- **Invariants:**
  - `Code` must be unique (at least per restaurant, potentially globally).
  - `ValidityEndDate` must be after `ValidityStartDate`.
  - `CurrentTotalUsageCount` cannot exceed `TotalUsageLimit`.
  - A coupon cannot be applied if it's not `IsEnabled` or outside its validity period.
- **References to other aggregates (by ID):**
  - `RestaurantID` (The restaurant that created/owns this coupon).
  - (Potentially) `MenuItemID`s in `AppliesTo.ItemIDs`.

**5. `Review` Aggregate**

- **Aggregate Root:** `Review`
- **Description:** Captures customer feedback and ratings for restaurants, typically linked to a completed order.
- **Entities/Value Objects (VOs) within:**
  - `Review` (Entity - Root):
    - `ReviewID` (Identifier)
    - `Rating` (Integer, 1-5)
    - `Comment` (Text, optional)
    - `SubmissionTimestamp`
    - `IsModerated` (Boolean, if admin reviewed/approved)
    - `IsHidden` (Boolean, if admin hid the review)
- **Invariants:**
  - `Rating` must be between 1 and 5 (inclusive).
  - A review must be linked to a `CustomerID` and `RestaurantID`.
- **References to other aggregates (by ID):**
  - `CustomerID` (`UserID` of the reviewer).
  - `RestaurantID` (The restaurant being reviewed).
  - `OrderID` (The order that prompted the review, ensures review authenticity).

**6. `Tag` Aggregate**

- **Aggregate Root:** `Tag`
- **Description:** Manages centrally defined tags (e.g., dietary preferences, cuisine styles) that can be applied to menu items for discovery and filtering.
- **Entities/Value Objects (VOs) within:**
  - `Tag` (Entity - Root):
    - `TagID` (Identifier)
    - `TagName` (String, e.g., "Vegetarian", "Gluten-Free", "Spicy")
    - `TagDescription` (Optional)
    - `TagCategory` (Optional string, e.g., "Dietary", "Cuisine")
- **Invariants:**
  - `TagName` should be unique.
- **References to other aggregates (by ID):**
  - None. (It is referenced *by* the `Restaurant` aggregate via `MenuItem.DietaryTagIDs`).
